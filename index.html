<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gabble</title>
  <style>
    body{margin:0;font-family:Arial,sans-serif;display:flex;justify-content:center;align-items:center;height:100vh;background:linear-gradient(135deg,#667eea,#764ba2);}
    .chat-container{width:95%;max-width:900px;height:90vh;background:white;border-radius:10px;box-shadow:0 4px 10px rgba(0,0,0,0.2);display:flex;flex-direction:column;overflow:hidden;}
    .chat-header{background:#764ba2;color:white;padding:10px;display:flex;justify-content:space-between;align-items:center;}
    .chat-box{flex:1;padding:10px;overflow-y:auto;display:flex;flex-direction:column;background:#f4f4f4;}
    .message{max-width:80%;padding:10px;margin:5px;border-radius:10px;word-wrap:break-word;white-space:pre-wrap;}
    .my-message{background:#667eea;color:white;align-self:flex-end;}
    .other-message{background:#e0e0e0;color:black;align-self:flex-start;}
    .message .content{max-width:100%;}
    .message pre{background:#0f172a;color:#e2e8f0;padding:8px;border-radius:8px;overflow-x:auto;}
    .message code{font-family:monospace;background:#11182715;padding:2px 4px;border-radius:4px;}
    .chat-input{border-top:1px solid #ddd;padding:8px;background:white;display:flex;gap:5px;}
    .chat-input input{flex:1;padding:10px;border:1px solid #ddd;border-radius:5px;}
    .chat-input button{background:#667eea;color:white;border:none;padding:8px 12px;border-radius:5px;cursor:pointer;}
  </style>
</head>
<body>
  <div class="chat-container">
    <div class="chat-header">
      Gabble <span id="online-users">Online: 0</span>
    </div>
    <div id="chat-box" class="chat-box"></div>
    <div class="chat-input">
      <input id="username" placeholder="Your Name"/>
      <input id="message" placeholder="Type a message..." disabled/>
      <button onclick="sendMessage()" disabled>Send</button>
    </div>
  </div>

  <!-- Socket.io + Markdown -->
  <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.6/dist/purify.min.js"></script>

  <script>
    const socket=io("https://chat-app-ydcu.onrender.com");
    let username="";

    function setReady(){
      username=document.getElementById("username").value.trim();
      if(!username) return;
      socket.emit("setUsername",username);
      document.getElementById("message").disabled=false;
      document.querySelector(".chat-input button").disabled=false;
      document.getElementById("username").disabled=true;
    }

    document.getElementById("username").addEventListener("keydown",e=>{
      if(e.key==="Enter"){setReady();}
    });

    function sendMessage(){
      const text=document.getElementById("message").value.trim();
      if(!text) return;
      socket.emit("message",{username,message:text,type:"text"});
      document.getElementById("message").value="";
    }

    document.getElementById("message").addEventListener("keydown",e=>{
      if(e.key==="Enter"&&!e.shiftKey){e.preventDefault();sendMessage();}
    });

    socket.on("message",data=>{
      const box=document.getElementById("chat-box");
      const msg=document.createElement("div");
      msg.classList.add("message");
      if(data.username===username) msg.classList.add("my-message"); else msg.classList.add("other-message");

      const content=document.createElement("div");
      content.className="content";
      if(data.type==="text"){
        const dirty=marked.parse(data.message||"");
        content.innerHTML=DOMPurify.sanitize(dirty);
      } else {
        content.textContent=data.message;
      }

      msg.appendChild(content);
      box.appendChild(msg);
      box.scrollTop=box.scrollHeight;
    });

    socket.on("onlineUsers",data=>{
      document.getElementById("online-users").innerText=`Online: ${data.count||data.length}`;
    });
  </script>
</body>
</html>
